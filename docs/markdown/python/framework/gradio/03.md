# 三、Blocks使用

## 3.1  Blacks

它提供了一种可视化方式来组合和重用交互式组件。通过使用gr.Blocks，您可以创建复杂的界面布局，并将输入、输出和其他组件组合在一起。每个块都有自己的输入和输出，可以连接到其他块，以构建数据流和处理流程。

### 3.1.1 参数类型

1. Row

    Row是Blocks模块中的一个布局元素，它将所有子组件水平排列。

    参数：

    - variant：行类型，可选值为’default’（无背景），’panel’（灰色背景和圆角）或’compact’（圆角且无内部间隔）。
    - visible：是否显示行，默认为True。
    - elem_id：可选的HTML DOM的ID，可用于定位CSS样式。
    - equal_height：是否使每个子元素具有相等的高度，默认为True。

2. Column

    Column是Blocks模块中的一个布局元素，它将所有子组件垂直排列。可以通过scale和min_width参数设置列的宽度。

    参数：

    - scale：相对于相邻列的宽度比例，默认为1。例如，如果列A的scale为2，列B的scale为1，则A的宽度是B的两倍。
    - min_width：列的最小像素宽度，默认为320。如果某个scale值导致列宽度小于min_width，则将尊重min_width参数。
    - variant：列类型，可选值为’default’（无背景），’panel’（灰色背景和圆角）或’compact’（圆角且无内部间隔）。
    - visible：是否显示列，默认为True。
    - elem_id：可选的HTML DOM的ID，可用于定位CSS样式。


3. Tab

    Tab（或其别名TabItem）是Blocks模块中的一个布局元素，组件定义在选中的标签页中可见。

    参数：

    - label：选项卡的可视标签，必填项。
    - id：选项卡的标识符，如果希望从预测函数控制选定的选项卡，则必填。
    - elem_id：可选的HTML DOM的ID，可用于定位CSS样式。

4. Group

    数据放入到一起

5. Accordion

    Accordion是Blocks模块中的一个布局元素，可以切换显示/隐藏所包含的内容。

    参数：

    - label：手风琴部分的名称，必填项。
    - open：如果为True，则手风琴默认展开。
    - visible：是否显示手风琴，默认为True。
    - elem_id：可选的HTML DOM的ID，可用于定位CSS样式。

### 3.1.2 实际操作

1. 代码实例：

    使用Gradio的gr.Blocks创建的交互式界面示例。它允许用户输入姓名，并在点击按钮后显示欢迎消息。

    ```py
    import gradio as gr
    def update(name):
        return f"Welcome to Gradio, {name}!"
    with gr.Blocks() as demo:
        gr.Markdown("Start typing below and then click **Run** to see the output.")
        with gr.Row():
            inp = gr.Textbox(placeholder="What is your name?")
            out = gr.Textbox()
        btn = gr.Button("Run")
        btn.click(fn=update, inputs=inp, outputs=out)
    demo.launch()
    ```

2. 运行界面：

    ![](/python/framework/gradio/005.png)


3. 示例分析

    - 在这个示例中，使用了gr.Blocks()上下文管理器来创建Gradio界面。然后，使用gr.Markdown组件添加了一个文本说明。
    - 接下来，在gr.Row()中创建了一个输入文本框（gr.Textbox）和一个输出文本框（gr.Textbox）。输入文本框用于接收用户输入的姓名，输出文本框用于显示欢迎消息。
    - 然后，使用gr.Button创建了一个按钮（btn），并使用btn.click()方法指定了按钮点击事件的处理函数为update。update函数接受用户输入的姓名，并返回欢迎消息。
    - 最后，使用demo.launch()来启动Gradio应用程序，并在本地的Web服务器上运行它。

    - 运行该代码后，您将在命令行中看到一个本地的URL地址，类似于`http://127.0.0.1:7860/`。将此URL复制到浏览器中，您将能够访问该应用程序，并在输入框中输入姓名，然后点击按钮来查看欢迎消息的输出。
    - gr.Interface适用于创建简单的交互式应用程序，而gr.Blocks则适用于创建更复杂的界面布局和数据流程。您可以根据自己的需求选择适合的方法。


## 3.2 模仿stable-diffsion web-ui


1. 代码示例


    - index.py
        ```py
        import gradio as gr

        with gr.Blocks(css="style.css") as demo:
            with gr.Tab(label="txt.img"):
                with gr.Row():
                    with gr.Column(scale=15):
                        txt1 = gr.Textbox(lines=2,label="")
                        txt2 = gr.Textbox(lines=2, label="")
                    with gr.Column(scale=1,min_width=1,elem_id="btn-list"):
                        button1 = gr.Button(value="1",elem_classes="btn")
                        # button1.click(Fn)
                        button2 = gr.Button(value="2",elem_classes="btn")
                        button3 = gr.Button(value="3",elem_classes="btn")
                        button4 = gr.Button(value="4",elem_classes="btn")
                    with gr.Column(scale=6):
                        generate_button = gr.Button(value="Generate",variant="primary",scale=1)
                        with gr.Row():
                            dropdown = gr.Dropdown(["1","2","3","4"],label="style1")
                            dropdown2 = gr.Dropdown(["1","2","3","4"],label="style2")
                with gr.Row():
                    with gr.Column():
                        with gr.Row():
                            dropdown3 = gr.Dropdown(["1","2","3","4"],label="Sampling method")
                            slider1 = gr.Slider(minimum=0,maximum=100,label="Sampling steps")
                        checkboxgroup = gr.Checkboxgroup(["Restore faces","Tiling","Hires.fix"],label="")
                        with gr.Row():
                            slider2 = gr.Slider(minimum=0,maximum=100,label="Width")
                            slider3 = gr.Slider(minimum=0, maximum=100, label="Batch count")
                        with gr.Row():
                            slider4 = gr.Slider(minimum=0,maximum=100,label="Height")
                            slider5 = gr.Slider(minimum=0, maximum=100, label="Batch size")
                        slider6 = gr.Slider(minimum=0, maximum=100, label="CFG scale")
                        with gr.Row():
                            number1 = gr.Number(label="Send",scale=10)
                            button5 = gr.Button(value="Randomize",min_width=1)
                            button6 = gr.Button(value="Reset",min_width=1)
                            checkbox1 = gr.Checkbox(label="Extra",min_width=10)
                        dropdown4 = gr.Dropdown(["1","2","3","4"],label="Script")
                    with gr.Column():
                            gallery = gr.Gallery([
                                "https://nimg.ws.126.net/?url=http%3A%2F%2Fdingyue.ws.126.net%2F2023%2F0103%2Fb746eb5cj00rnwgou003wd000vk01k4m.jpg&thumbnail=660x2147483647&quality=80&type=jpg",
                                "https://nimg.ws.126.net/?url=http%3A%2F%2Fdingyue.ws.126.net%2F2023%2F0103%2Fd21c881aj00rnwgos004jd000vk01k4m.jpg&thumbnail=660x2147483647&quality=80&type=jpg",
                                "https://nimg.ws.126.net/?url=http%3A%2F%2Fdingyue.ws.126.net%2F2023%2F0103%2Fc894297cj00rnwgot003nd000vk01k4m.jpg&thumbnail=660x2147483647&quality=80&type=jpg",
                                "https://nimg.ws.126.net/?url=http%3A%2F%2Fdingyue.ws.126.net%2F2023%2F0103%2F1053f980j00rnwgos003kd000vk01k4m.jpg&thumbnail=660x2147483647&quality=80&type=jpg",
                                "https://nimg.ws.126.net/?url=http%3A%2F%2Fdingyue.ws.126.net%2F2023%2F0103%2F1677746bj00rnwgo60047d000vl01k5m.jpg&thumbnail=660x2147483647&quality=80&type=jpg",
                                "https://nimg.ws.126.net/?url=http%3A%2F%2Fdingyue.ws.126.net%2F2023%2F0103%2F86148a4bj00rnwgo7003pd000vl01k5m.jpg&thumbnail=660x2147483647&quality=80&type=jpg",
                                "https://nimg.ws.126.net/?url=http%3A%2F%2Fdingyue.ws.126.net%2F2023%2F0103%2Fbe46ab41j00rnwgoc003xd000vl01k5m.jpg&thumbnail=660x2147483647&quality=80&type=jpg",
                            ],columns=3)
                            with gr.Row():
                                button7 = gr.Button(value="save",min_width=1)
                                button8 = gr.Button(value="save",min_width=1)
                                button9 = gr.Button(value="Zip",min_width=1)
                                button10 = gr.Button(value="Send to ima2img",min_width=1)
                                button11 = gr.Button(value="Send to inpaint",min_width=1)
                                button12 = gr.Button(value="Send to extras",min_width=1)
                            txt3 = gr.Textbox(lines=4,label="")
            #  用于测试剩下的两个组件信息 Group Accordion
            with gr.Tab(label="txt.img"):
                with gr.Column():
                    with gr.Row():
                        # 不分距离
                        with gr.Group():
                            button20 = gr.Button(value="2", elem_classes="btn")
                            button21 = gr.Button(value="3", elem_classes="btn")
                            # 不分距离
                        with gr.Group():
                            txt22 = gr.Textbox(lines=2, label="")
                            txt23 = gr.Textbox(lines=2, label="")
                        txt20 = gr.Textbox(lines=2, label="")
                        txt21 = gr.Textbox(lines=2, label="")
                        button24 = gr.Button(value="2", elem_classes="btn")
                        button25 = gr.Button(value="3", elem_classes="btn")
                    with gr.Accordion():
                        txt5 = gr.Textbox(lines=6, label="")
                        txt6 = gr.Textbox(lines=7, label="")
                        txt7 = gr.Textbox(lines=8, label="")
        demo.launch()
        ```

    - style.css 样式

        ```css
        .btn {
            width: 30px;
            height: 30px;
        }

        #btn-list {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .form.svelte-sfqy0y {
            border: 0;
        }
        ```
2. 运行结果

    - 原图

        ![](/python/framework/gradio/006.png)
    - 展示图

        ![](/python/framework/gradio/007.png)


## 3.3 其他

1. gr.change()互动用法

    change方法用于在组件的值发生变化时触发事件，无论是因为用户输入（例如用户在文本框中输入）还是函数更新（例如图像从事件触发的输出接收到值）。该方法适用于Gradio Blocks中的组件。

    参数说明：

    - fn：函数，通常是机器学习模型的预测函数。函数的每个参数对应一个输入组件，函数应该返回单个值或一个值元组，其中元组中的每个元素对应一个输出组件。
    - inputs：用作输入的组件列表，如果函数不需要输入，应该是一个空列表。
    - outputs：用作输出的组件列表，如果函数不返回输出，应该是一个空列表。
    - api_name：字符串，用于在API文档中公开该端点。
    - status_tracker：无，预留参数。
    - scroll_to_output：布尔值，如果为True，在完成时将滚动到输出组件。
    - show_progress：字符串，控制是否显示进度动画。
    - queue：布尔值，如果为True，将在队列中排队请求（如果已启用队列）。如果为False，即使启用了队列，也不会将此事件放入队列。如果为None，则使用Gradio应用的队列设置。
    - batch：布尔值，如果为True，函数应处理一批输入，这意味着它应接受每个参数的输入值列表。列表应该具有相等的长度（最大长度为max_batch_size）。然后，函数必须强制返回一个元组列表（即使只有一个输出组件），元组中的每个列表对应一个输出组件。
    - max_batch_size：整数，如果从队列调用此方法，最大批量处理输入的数量（仅当batch=True时有效）。
    - preprocess：布尔值，如果为False，则在运行’fn’之前不会运行组件数据的预处理（例如，如果使用Image组件调用此方法，则保留其作为base64字符串）。
    - postprocess：布尔值，如果为False，则在将’fn’的输出返回给浏览器之前不会运行组件数据的后处理。
    - cancels：其他事件的字典或列表，当触发此监听器时取消其他事件。例如，设置cancels=[click_event]将取消click_event，其中click_event是另一个组件的.click方法的返回值。尚未运行的函数（或正在迭代的生成器）将被取消

2. 来看一个案例：

    - 代码示例
        
        ```py
        import gradio as gr
        
        def change_textbox(choice):
            if choice == "short":
                return gr.Textbox(lines=2, visible=True)
            elif choice == "long":
                return gr.Textbox(lines=8, visible=True, value="Lorem ipsum dolor sit amet")
            else:
                return gr.Textbox(visible=False)
        
        with gr.Blocks() as demo:
            radio = gr.Radio(
                ["short", "long", "none"], label="What kind of essay would you like to write?"
            )
            text = gr.Textbox(lines=2, interactive=True, show_copy_button=True)
            radio.change(fn=change_textbox, inputs=radio, outputs=text)
        
        demo.launch()
        ```
    - 运行结果

        ![](/python/framework/gradio/008.png)

3. 第二个案例
 
    - 代码示例

        ```py
        import math
        import gradio as gr
        import plotly.express as px
        import numpy as np
        plot_end = 2 * math.pi
        
        def get_plot(period=1):
            global plot_end
            x = np.arange(plot_end - 2 * math.pi, plot_end, 0.02)
            y = np.sin(2 * math.pi * period * x)
            fig = px.line(x=x, y=y)
            plot_end += 2 * math.pi
            if plot_end > 1000:
                plot_end = 2 * math.pi
            return fig
        
        with gr.Blocks() as demo:
            with gr.Row():
                with gr.Column():
                    gr.Markdown("Change the value of the slider to automatically update the plot")
                    period = gr.Slider(label="Period of plot", value=1, minimum=0, maximum=10, step=1)
                    plot = gr.Plot(label="Plot (updates every half second)")
            dep = demo.load(get_plot, None, plot, every=1)
            period.change(get_plot, period, plot, every=1, cancels=[dep])
        if __name__ == "__main__":
            demo.queue().launch()
        ```
    - 运行结果

        ![](/python/framework/gradio/009.png)