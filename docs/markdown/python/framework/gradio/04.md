# 四、机器学习实战

1. 代码

    ```py
    from torchvision import transforms
    from PIL import Image
    import gradio as gr
    import torch
    from ultralytics import YOLO
    import torch.hub
    #模型定义
    #语义分割 下载路径 https://github.com/ultralytics/assets/releases/tag/v8.1.0
    model_seg = YOLO("models/yolov8s-seg.pt")
    #目标检测
    model_detect = YOLO("models/yolov8s-oiv7.pt")
    #图像分类
    model_cls = torch.hub.load('pytorch/vision:v0.6.0', 'resnet18', pretrained=True).eval()
    #图像分类的词
    file_path = './label/categories.txt'
    with open(file_path,'r') as file:
        labels = file.readlines()
    labels = [label.rsplit(",")[0] for label in labels]
    
    def seg(image):
        results = model_seg([image])
        for r in results:
            im_array = r.plot()
            img = Image.fromarray(im_array[...,::-1])
        return img
    def det(image):
        results = model_detect([image])
        for r in results:
            im_array = r.plot()
            img = Image.fromarray(im_array[..., ::-1])
        return img
    def cls(image):
        image = transforms.ToTensor()(image).unsqueeze(0)
        with torch.no_grad():
            prediction = torch.nn.functional.softmax(model_cls(image)[0],dim=0)
            confidences = {labels[i]:float(prediction[i]) for i in range(1000)}
        return confidences
    
    with gr.Blocks() as demo:
        with gr.Tab("图像分类"):
                gr.Markdown("# 图像分类展示")
                with gr.Row():
                    input_img = gr.Image(sources={"upload"},label="上传图片",type="pil")
                    output_label = gr.Label(num_top_classes=10)
                gr.Examples(["./images/dog.jpg","./images/cat.jpg"],inputs=[input_img])
                button = gr.Button("分类",variant="primary")
                button.click(cls,inputs=input_img,outputs=output_label)
        with gr.Tab("语义分割"):
                gr.Markdown("# 语义分割展示")
                with gr.Row():
                    input_img = gr.Image(sources={"upload"}, label="上传图片", type="pil")
                    output_img = gr.Image(type="pil")
                gr.Examples(["./images/dog.jpg", "./images/cat.jpg", "./images/dc.jpg"], inputs=[input_img])
                button = gr.Button("分类", variant="primary")
                button.click(seg, inputs=input_img, outputs=output_img)
        with gr.Tab("目标检测"):
            gr.Markdown("# 目标检测展示")
            with gr.Row():
                input_img = gr.Image(sources={"upload"}, label="上传图片", type="pil")
                output_img = gr.Image(type="pil")
            gr.Examples(["./images/dog.jpg", "./images/cat.jpg", "./images/dc.jpg"], inputs=[input_img])
            button = gr.Button("分类", variant="primary")
            button.click(det, inputs=input_img, outputs=output_img)
    demo.launch(share=True)
    ```
2. 运行结果

    ![](/python/framework/gradio/010.png)
